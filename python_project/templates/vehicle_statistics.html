<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê phương tiện giao thông</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stat-card {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        .table-custom {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-custom {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 25px;
            padding: 10px 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .date-filter {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-car me-2"></i>
                Vehicle Detection System
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/detection">
                            <i class="fas fa-video me-1"></i>Nhận diện
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/statistics">
                            <i class="fas fa-chart-bar me-1"></i>Thống kê
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/regulations">
                            <i class="fas fa-book me-1"></i>Quy định
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="fw-bold">
                    <i class="fas fa-chart-line me-2"></i>
                    Thống kê phương tiện giao thông
                </h2>
                <p class="text-muted">Phân tích và báo cáo chi tiết về lưu lượng giao thông</p>
            </div>
        </div>

        <!-- Date Filter -->
        <div class="date-filter">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Từ ngày:</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Đến ngày:</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">Khoảng thời gian:</label>
                    <select id="timeRange" class="form-select">
                        <option value="7">7 ngày qua</option>
                        <option value="30" selected>30 ngày qua</option>
                        <option value="90">90 ngày qua</option>
                        <option value="365">1 năm qua</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button id="filterBtn" class="btn btn-custom w-100 mt-4">
                        <i class="fas fa-filter me-2"></i>Lọc dữ liệu
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-lg-2 col-md-4 col-6">
                <div class="stat-card">
                    <i class="fas fa-car fa-2x mb-3"></i>
                    <h3 id="totalCar">0</h3>
                    <p class="mb-0">Ô tô</p>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="stat-card">
                    <i class="fas fa-truck fa-2x mb-3"></i>
                    <h3 id="totalTruck">0</h3>
                    <p class="mb-0">Xe tải</p>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="stat-card">
                    <i class="fas fa-bus fa-2x mb-3"></i>
                    <h3 id="totalBus">0</h3>
                    <p class="mb-0">Xe buýt</p>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="stat-card">
                    <i class="fas fa-motorcycle fa-2x mb-3"></i>
                    <h3 id="totalMotorcycle">0</h3>
                    <p class="mb-0">Xe máy</p>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="stat-card">
                    <i class="fas fa-bicycle fa-2x mb-3"></i>
                    <h3 id="totalBicycle">0</h3>
                    <p class="mb-0">Xe đạp</p>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-6">
                <div class="stat-card" style="background: linear-gradient(45deg, #28a745, #20c997);">
                    <i class="fas fa-calculator fa-2x mb-3"></i>
                    <h3 id="grandTotal">0</h3>
                    <p class="mb-0">Tổng cộng</p>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Pie Chart -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-pie me-2"></i>
                        Phân bố phương tiện
                    </h5>
                    <canvas id="pieChart" width="400" height="300"></canvas>
                </div>
            </div>
            
            <!-- Bar Chart -->
            <div class="col-lg-6">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar me-2"></i>
                        Thống kê theo ngày
                    </h5>
                    <canvas id="barChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Line Chart -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="chart-container">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-line me-2"></i>
                        Xu hướng lưu lượng giao thông
                    </h5>
                    <canvas id="lineChart" width="800" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Table -->
        <div class="row">
            <div class="col-12">
                <div class="table-custom">
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>
                            Chi tiết thống kê theo ngày
                        </h5>
                        <div>
                            <button id="exportBtn" class="btn btn-custom me-2">
                                <i class="fas fa-download me-2"></i>Xuất Excel
                            </button>
                            <button id="printBtn" class="btn btn-secondary">
                                <i class="fas fa-print me-2"></i>In báo cáo
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Ngày</th>
                                    <th>Ô tô</th>
                                    <th>Xe tải</th>
                                    <th>Xe buýt</th>
                                    <th>Xe máy</th>
                                    <th>Xe đạp</th>
                                    <th>Tổng cộng</th>
                                    <th>% Thay đổi</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let pieChart, barChart, lineChart;
        let statisticsData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupDateFilters();
            setupEventListeners();
            loadStatistics();
        });

        function setupDateFilters() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        function setupEventListeners() {
            document.getElementById('filterBtn').addEventListener('click', loadStatistics);
            document.getElementById('timeRange').addEventListener('change', updateDateRange);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('printBtn').addEventListener('click', printReport);
        }

        function updateDateRange() {
            const days = parseInt(document.getElementById('timeRange').value);
            const today = new Date();
            const startDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));
            
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            
            loadStatistics();
        }

        function loadStatistics() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            fetch(`/api/get_daily_statistics?start_date=${startDate}&end_date=${endDate}`)
                .then(response => response.json())
                .then(data => {
                    statisticsData = data;
                    updateSummaryStatistics(data);
                    updateCharts(data);
                    updateTable(data);
                })
                .catch(error => {
                    console.error('Error loading statistics:', error);
                    showNotification('Lỗi khi tải dữ liệu thống kê', 'error');
                });
        }

        function updateSummaryStatistics(data) {
            let totalCar = 0, totalTruck = 0, totalBus = 0, totalMotorcycle = 0, totalBicycle = 0;
            
            data.forEach(item => {
                totalCar += item.car;
                totalTruck += item.truck;
                totalBus += item.bus;
                totalMotorcycle += item.motorcycle;
                totalBicycle += item.bicycle;
            });

            const grandTotal = totalCar + totalTruck + totalBus + totalMotorcycle + totalBicycle;

            document.getElementById('totalCar').textContent = totalCar.toLocaleString();
            document.getElementById('totalTruck').textContent = totalTruck.toLocaleString();
            document.getElementById('totalBus').textContent = totalBus.toLocaleString();
            document.getElementById('totalMotorcycle').textContent = totalMotorcycle.toLocaleString();
            document.getElementById('totalBicycle').textContent = totalBicycle.toLocaleString();
            document.getElementById('grandTotal').textContent = grandTotal.toLocaleString();
        }

        function updateCharts(data) {
            updatePieChart(data);
            updateBarChart(data);
            updateLineChart(data);
        }

        function updatePieChart(data) {
            const ctx = document.getElementById('pieChart').getContext('2d');
            
            // Calculate totals
            let totalCar = 0, totalTruck = 0, totalBus = 0, totalMotorcycle = 0, totalBicycle = 0;
            
            data.forEach(item => {
                totalCar += item.car;
                totalTruck += item.truck;
                totalBus += item.bus;
                totalMotorcycle += item.motorcycle;
                totalBicycle += item.bicycle;
            });

            if (pieChart) {
                pieChart.destroy();
            }

            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Ô tô', 'Xe tải', 'Xe buýt', 'Xe máy', 'Xe đạp'],
                    datasets: [{
                        data: [totalCar, totalTruck, totalBus, totalMotorcycle, totalBicycle],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateBarChart(data) {
            const ctx = document.getElementById('barChart').getContext('2d');
            
            const labels = data.map(item => item.date);
            const carData = data.map(item => item.car);
            const truckData = data.map(item => item.truck);
            const busData = data.map(item => item.bus);
            const motorcycleData = data.map(item => item.motorcycle);
            const bicycleData = data.map(item => item.bicycle);

            if (barChart) {
                barChart.destroy();
            }

            barChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ô tô',
                            data: carData,
                            backgroundColor: '#FF6384'
                        },
                        {
                            label: 'Xe tải',
                            data: truckData,
                            backgroundColor: '#36A2EB'
                        },
                        {
                            label: 'Xe buýt',
                            data: busData,
                            backgroundColor: '#FFCE56'
                        },
                        {
                            label: 'Xe máy',
                            data: motorcycleData,
                            backgroundColor: '#4BC0C0'
                        },
                        {
                            label: 'Xe đạp',
                            data: bicycleData,
                            backgroundColor: '#9966FF'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateLineChart(data) {
            const ctx = document.getElementById('lineChart').getContext('2d');
            
            const labels = data.map(item => item.date);
            const totalData = data.map(item => item.total);

            if (lineChart) {
                lineChart.destroy();
            }

            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tổng phương tiện',
                        data: totalData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const total = item.car + item.truck + item.bus + item.motorcycle + item.bicycle;
                
                // Calculate percentage change
                let percentageChange = 0;
                if (index > 0) {
                    const prevTotal = data[index - 1].car + data[index - 1].truck + 
                                    data[index - 1].bus + data[index - 1].motorcycle + data[index - 1].bicycle;
                    percentageChange = prevTotal > 0 ? ((total - prevTotal) / prevTotal) * 100 : 0;
                }

                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.car.toLocaleString()}</td>
                    <td>${item.truck.toLocaleString()}</td>
                    <td>${item.bus.toLocaleString()}</td>
                    <td>${item.motorcycle.toLocaleString()}</td>
                    <td>${item.bicycle.toLocaleString()}</td>
                    <td><strong>${total.toLocaleString()}</strong></td>
                    <td>
                        <span class="badge ${percentageChange >= 0 ? 'bg-success' : 'bg-danger'}">
                            ${percentageChange >= 0 ? '+' : ''}${percentageChange.toFixed(1)}%
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function exportToExcel() {
            // Simple CSV export
            let csv = 'Ngày,Ô tô,Xe tải,Xe buýt,Xe máy,Xe đạp,Tổng cộng\n';
            
            statisticsData.forEach(item => {
                const total = item.car + item.truck + item.bus + item.motorcycle + item.bicycle;
                csv += `${item.date},${item.car},${item.truck},${item.bus},${item.motorcycle},${item.bicycle},${total}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vehicle_statistics_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Đã xuất file CSV thành công', 'success');
        }

        function printReport() {
            window.print();
        }

        function showNotification(message, type) {
            // Simple alert for now
            alert(message);
        }
    </script>
</body>
</html>
